<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OSINT Intelligence Workbench</title>

<link rel="manifest" href="manifest.json">

<!-- Service worker -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

<style>
:root{
  --bg:#05070e;
  --panel:#0f172a;
  --card:#0b1220;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#38bdf8;
  --border:#1f2937;
  --shadow:rgba(0,0,0,.35);
}

.light{
  --bg:#f3f4f6;
  --panel:#ffffff;
  --card:#ffffff;
  --text:#020617;
  --muted:#4b5563;
  --accent:#0ea5e9;
  --border:#e5e7eb;
  --shadow:rgba(0,0,0,.08);
}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

/* LOGIN SCREEN */
#loginScreen{
  position:fixed;
  inset:0;
  background:#020617;
  display:flex;
  align-items:center;
  justify-content:center;
}

.login-box{
  background:var(--panel);
  border:1px solid var(--border);
  padding:28px;
  border-radius:16px;
  text-align:center;
  width:320px;
}

/* APP LAYOUT */
.app{
  height:100vh;
  display:none;
}

.sidebar{
  width:240px;
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:14px 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.logo{
  font-weight:700;
  text-align:center;
}

.navbtn{
  background:var(--card);
  border:1px solid var(--border);
  padding:10px;
  border-radius:14px;
  cursor:pointer;
  text-align:left;
}
.navbtn.active{
  background:var(--accent);
  color:black;
}

.main{
  flex:1;
  overflow:auto;
  padding:16px;
}

section{
  display:none;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}
section.active{display:block;}

button{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
  cursor:pointer;
}

textarea,input,select{
  width:100%;
  background:var(--panel);
  border-radius:12px;
  padding:10px;
  border:1px solid var(--border);
  color:var(--text);
}
canvas{
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
}
</style>
</head>

<body>

<!-- GOOGLE LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <h2>ğŸ•µ OSINT Workbench</h2>
    <p>Sign in with Google to continue</p>
    <button onclick="googleLogin()">ğŸ”‘ Sign in with Google</button>
    <p id="loginStatus" style="color:#9ca3af;margin-top:10px;"></p>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="sidebar">

  <div class="logo">OSINT Workbench</div>
  <div id="userEmail" style="font-size:12px;text-align:center;color:var(--muted)"></div>

  <!-- NAVIGATION -->
  <div class="navbtn" data-target="vaults">ğŸ“‚ Vaults</div>
  <div class="navbtn" data-target="notes">ğŸ“ Notes</div>
  <div class="navbtn" data-target="keywords">ğŸ”‘ Keywords</div>
  <div class="navbtn" data-target="graph">ğŸ•¸ Graph</div>
  <div class="navbtn" data-target="matrix">ğŸ§® Co-occurrence</div>
  <div class="navbtn" data-target="entities">ğŸ§  Entities</div>
  <div class="navbtn" data-target="calendar">ğŸ“… Calendar</div>
  <div class="navbtn" data-target="attachments">ğŸ“ Attachments</div>
  <div class="navbtn" data-target="map">ğŸ—º Map</div>
  <div class="navbtn" data-target="compare">âš– Compare</div>
  <div class="navbtn" data-target="themes">ğŸ¨ Themes</div>
  <div class="navbtn" data-target="report">ğŸ“„ Reports</div>
  <div class="navbtn" data-target="pdfextract">ğŸ“• PDF Extract</div>
  <div class="navbtn" data-target="export">â¬†â¬‡ Import / Export</div>

  <div class="navbtn" onclick="logout()">ğŸšª Logout</div>
  <div class="navbtn" onclick="toggleTheme()">ğŸŒ— Theme</div>

</div>

<div class="main">

<!-- VAULTS -->
<section id="vaults" class="active">
<h2>Vaults</h2>
<input id="newVaultName" placeholder="New vault name">
<button onclick="createVault()">Create</button>
<div id="vaultList"></div>
</section>

<!-- NOTES -->
<section id="notes">
<h2>Markdown Notes</h2>
<textarea id="mdInput" placeholder="# Write markdown and use [[WikiLinks]]"></textarea>
<button onclick="togglePreview()">Preview</button>
<div id="mdPreview" style="display:none"></div>
</section>

<!-- KEYWORDS -->
<section id="keywords">
<h2>Keywords</h2>
<input id="kwInput" placeholder="Add keyword">
<button onclick="addKeyword()">Add</button>
<div id="keywordBox"></div>
<canvas id="keywordChart" width="400" height="220"></canvas>
</section>

<!-- GRAPH -->
<section id="graph">
<h2>Backlink / Keyword Graph</h2>
<canvas id="graphCanvas" width="520" height="420"></canvas>
</section>

<!-- MATRIX -->
<section id="matrix">
<h2>Co-occurrence Matrix</h2>
<div id="matrixBox"></div>
</section>

<!-- ENTITIES -->
<section id="entities">
<h2>Entity Detector (rule-based)</h2>
<button onclick="detectEntities()">Run</button>
<div id="entityBox"></div>
</section>

<!-- CALENDAR -->
<section id="calendar">
<h2>Calendar Heatmap</h2>
<div id="calendarBox"></div>
</section>

<!-- ATTACHMENTS -->
<section id="attachments">
<h2>Attachments</h2>
<input type="file" id="filePicker" multiple>
<button onclick="addAttachments()">Add</button>
<div id="attachmentList"></div>
</section>

<!-- MAP -->
<section id="map">
<h2>Geo Map (basic canvas)</h2>
<canvas id="mapCanvas" width="500" height="300"></canvas>
</section>

<!-- COMPARE -->
<section id="compare">
<h2>Side-by-Side Compare</h2>
<textarea id="leftText" placeholder="Aâ€¦"></textarea>
<textarea id="rightText" placeholder="Bâ€¦"></textarea>
<button onclick="compareTexts()">Compare</button>
<div id="compareResult"></div>
</section>

<!-- THEMES -->
<section id="themes">
<h2>Theme Builder</h2>
<label>Background</label><input type="color" id="bgCol">
<label>Text</label><input type="color" id="fgCol">
<label>Accent</label><input type="color" id="acCol">
<button onclick="applyTheme()">Apply</button>
</section>

<!-- REPORTS -->
<section id="report">
<h2>Report Generator</h2>
<select id="reportType">
<option>Incident Summary</option>
<option>Entity Profile</option>
<option>Country Brief</option>
</select>
<button onclick="generateReport()">Generate</button>
<textarea id="reportOut" style="height:40vh"></textarea>
</section>

<!-- PDF -->
<section id="pdfextract">
<h2>Offline PDF Extractor</h2>
<input type="file" id="pdfFile" accept="application/pdf">
<button onclick="extractPdf()">Extract</button>
<textarea id="pdfOutput" style="height:40vh"></textarea>
</section>

<!-- IMPORT / EXPORT -->
<section id="export">
  <h2>Import / Export Vault</h2>

  <button onclick="exportVault()">â¬‡ Export vault</button>
  <br><br>

  <input type="file" id="importFile" accept="application/json">
  <button onclick="importVault()">â¬† Import vault</button>
</section>


</div>
</div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD6F2TCqGB0HThGj0usvLHl30ZOphFRVkM",
  authDomain: "osint-workbench-dbe48.firebaseapp.com",
  projectId: "osint-workbench-dbe48",
  storageBucket: "osint-workbench-dbe48.firebasestorage.app",
  messagingSenderId: "673794583008",
  appId: "1:673794583008:web:dc67b8c5d739db44f2a385",
  measurementId: "G-3TXVZ5D32B"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ---------------- LOGIN ---------------- */
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("loginScreen").style.display="none";
    document.getElementById("app").style.display="flex";
    document.getElementById("userEmail").innerText=user.email;
  } else {
    document.getElementById("app").style.display="none";
    document.getElementById("loginScreen").style.display="flex";
  }
});

/* ---------------- THEME ---------------- */
function toggleTheme(){document.body.classList.toggle("light");}

/* ---------------- NAVIGATION ---------------- */
document.querySelectorAll(".navbtn").forEach(b=>{
  if(b.dataset.target){
    b.onclick=()=>{
      document.querySelectorAll(".navbtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll("section").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      document.getElementById(b.dataset.target).classList.add("active");
    };
  }
});

/* ---------------- VAULT STORAGE ---------------- */
let vaults = JSON.parse(localStorage.getItem("vaults") || "{}");
let currentVault = "default";

function saveVaults(){
  localStorage.setItem("vaults", JSON.stringify(vaults));
  renderVaults();
}
function createVault(){
  const n=document.getElementById("newVaultName").value.trim();
  if(!n) return;
  vaults[n]={notes:[]};
  currentVault=n;
  saveVaults();
}
function renderVaults(){
  const box=document.getElementById("vaultList");
  box.innerHTML="";
  Object.keys(vaults).forEach(v=>{
    const btn=document.createElement("button");
    btn.textContent=v+(v===currentVault?" âœ“":"");
    btn.onclick=()=>{currentVault=v;saveVaults()};
    box.appendChild(btn);
  });
}
renderVaults();

/* ---------------- KEYWORDS (ADD + DELETE + RENDER) ---------------- */

let keywords = JSON.parse(localStorage.getItem("keywords") || "[]");

function saveKeywords(){
  localStorage.setItem("keywords", JSON.stringify(keywords));
}

function addKeyword(){
  const input = document.getElementById("kwInput");
  const k = input.value.trim();
  if(!k) return;

  keywords.push(k);
  input.value = "";
  saveKeywords();
  renderKeywords();
}

function deleteKeyword(idx){
  keywords.splice(idx,1);
  saveKeywords();
  renderKeywords();
}

function renderKeywords(){
  const box = document.getElementById("keywordBox");

  if(!keywords.length){
    box.innerHTML = `<p style="color:var(--muted)">No keywords yet</p>`;
    return;
  }

  box.innerHTML = keywords
    .map((k,i)=>`
      <div style="
        display:flex;
        align-items:center;
        gap:8px;
        margin:4px;
        background:var(--panel);
        border:1px solid var(--border);
        padding:6px 10px;
        border-radius:12px;
      ">
        <span>ğŸ”‘ ${k}</span>
        <button onclick="deleteKeyword(${i})">âŒ</button>
      </div>
    `)
    .join("");
}

renderKeywords();


/* ---------------- NOTES + PREVIEW ---------------- */
function togglePreview(){
  const src=document.getElementById("mdInput").value;
  document.getElementById("mdPreview").style.display="block";
  document.getElementById("mdPreview").innerText=src;
}

/* ---------------- EXPORT / IMPORT (WORKING) ---------------- */

function exportVault(){
  try{
    const data = JSON.stringify(vaults, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "vault_backup.json";
    a.click();

    URL.revokeObjectURL(url);
  } catch(e){
    alert("Export failed: " + e.message);
  }
}

function importVault(){
  const input = document.getElementById("importFile");
  if(!input.files.length){
    alert("Select a JSON file first");
    return;
  }

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = e=>{
    try{
      vaults = JSON.parse(e.target.result);
      saveVaults();
      alert("Import successful");
    }catch(err){
      alert("Import failed â€” invalid JSON file");
    }
  };

  reader.readAsText(file);
}

function importVault(){
  const f=document.getElementById("importFile").files[0];
  const r=new FileReader();
  r.onload=e=>{
    vaults=JSON.parse(e.target.result);
    saveVaults();
  };
  r.readAsText(f);
}

/* ---------------- PDF ---------------- */
async function extractPdf(){
  const file=document.getElementById("pdfFile").files[0];
  if(!file) return;
  const array=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:array}).promise;
  let out="";
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const text=await page.getTextContent();
    out+=text.items.map(t=>t.str).join(" ")+"\n\n";
  }
  document.getElementById("pdfOutput").value=out;
}
</script>

</body>
</html>
