<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OSINT Intelligence Workbench</title>

<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<style>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OSINT Intelligence Workbench</title>

<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<style>
:root{
  --bg:#05070e;
  --panel:#0f172a;
  --card:#0b1220;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#38bdf8;
  --border:#1f2937;
}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

.app{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.main-container{
  width:100%;
  max-width:960px;
  padding:14px;
  box-sizing:border-box;
}

/* Sticky top bar */
header{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  padding:8px;
  justify-content:center;
  position:sticky;
  top:0;
  z-index:10;
  backdrop-filter:blur(14px);
  background:rgba(3,7,18,.45);
  border-bottom:1px solid var(--border);
}

/* Buttons */
button{
  padding:8px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel);
  color:white;
  cursor:pointer;
  transition:.15s;
}
button:hover{
  background:#020617;
  transform:translateY(-1px);
}
button.active{
  background:var(--accent);
  color:#020617;
}

/* Card-like Sections */
section{
  display:none;
  margin-top:14px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
}
section.active{display:block;}

/* Headings */
h1,h2,h3{
  margin-top:4px;
  letter-spacing:.3px;
}

/* Inputs + Textareas */
textarea,input{
  background:#020617;
  color:white;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  width:100%;
  box-sizing:border-box;
  margin-top:6px;
}

/* Keyword Pills */
.keyword-pill{
  padding:8px 12px;
  background:#042f2e;
  border-radius:999px;
  margin:4px;
  display:inline-block;
  cursor:pointer;
  border:1px solid #0d9488;
}

/* Panels / Canvases */
.graphBox,#mapCanvas,#keywordChart{
  border:1px solid var(--border);
  border-radius:16px;
  background:#020617;
  width:100%;
}

/* Attachments */
.attachment{
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  margin:6px 0;
  background:#020617;
}

/* Heat Grid */
.heat{
  display:grid;
  grid-template-columns:repeat(32,1fr);
  gap:2px;
}
.heat div{
  width:10px;height:10px;border-radius:3px;
}
</style>
</head>

<body>
<div class="app">
<div class="main-container">
</style>
</head>

<body>

<header>
<button class="tab active" data-target="vaults">Vaults</button>
<button class="tab" data-target="keywords">Keywords</button>
<button class="tab" data-target="graph">Graph</button>
<button class="tab" data-target="matrix">Matrix</button>
<button class="tab" data-target="entities">Entities</button>
<button class="tab" data-target="calendar">Calendar</button>
<button class="tab" data-target="attachments">Attachments</button>
<button class="tab" data-target="map">Map</button>
<button class="tab" data-target="markdown">Notebook</button>
<button class="tab" data-target="compare">Compare</button>
<button class="tab" data-target="themes">Themes</button>
<button class="tab" data-target="report">Report</button>
<button class="tab" data-target="export">Export</button>
</header>

<section id="vaults" class="active">
<h2>Projects / Vaults</h2>
<input id="newVaultName" placeholder="New vault name">
<button onclick="createVault()">Create</button>
<div id="vaultList"></div>
</section>

<section id="keywords">
<h2>Keywords</h2>
<div id="keywordBox"></div>
<canvas id="keywordChart" width="360" height="220"></canvas>
<div id="keywordResults"></div>
</section>

<section id="graph">
<h2>Keyword Graph</h2>
<div class="graphBox">
<canvas id="graphCanvas" width="360" height="340"></canvas>
</div>
</section>

<section id="matrix">
<h2>Co-occurrence Matrix</h2>
<div id="matrixBox"></div>
</section>

<section id="entities">
<h2>Entity Detection</h2>
<div id="entityBox"></div>
</section>

<section id="calendar">
<h2>Keyword Activity Calendar</h2>
<input id="calKey" placeholder="keyword">
<button onclick="drawCalendar()">Show</button>
<div id="calendarBox"></div>
</section>

<section id="attachments">
<h2>Attachment Manager</h2>
<input type="file" id="filePicker" multiple>
<button onclick="addAttachments()">Add</button>
<div id="attachmentList"></div>
</section>

<section id="map">
<h2>Geo Map</h2>
<canvas id="mapCanvas" width="360" height="260"></canvas>
<div id="markerList"></div>
</section>

<section id="markdown">
<h2>Markdown Notebook</h2>
<textarea id="mdInput" placeholder="# Write markdown…"></textarea>
<button onclick="togglePreview()">Toggle Preview</button>
<div id="mdPreview" style="display:none"></div>
</section>

<section id="compare">
<h2>Side-by-Side Compare</h2>
<textarea id="leftText" placeholder="Text A…"></textarea>
<textarea id="rightText" placeholder="Text B…"></textarea>
<button onclick="compareTexts()">Compare</button>
<div id="compareResult"></div>
</section>

<section id="themes">
<h2>Theme Builder</h2>
<label>Background</label><input type="color" id="bgCol">
<label>Foreground</label><input type="color" id="fgCol">
<label>Accent</label><input type="color" id="acCol">
<button onclick="applyTheme()">Apply</button>
</section>

<section id="report">
<h2>Report Generator</h2>
<select id="reportType">
<option>Incident Summary</option>
<option>Country Situation Brief</option>
<option>Entity Profile</option>
</select>
<button onclick="generateReport()">Generate</button>
<textarea id="reportOut" style="height:40vh"></textarea>
</section>

<section id="export">
<h2>Export / Import Vault</h2>
<button onclick="exportVault()">Export current vault</button><br><br>
<input type="file" id="importFile">
<button onclick="importVault()">Import vault</button>
</section>

<script>
/* Tabs */
document.querySelectorAll('.tab').forEach(b=>{
 b.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('section').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  document.getElementById(b.dataset.target).classList.add('active');
 };
});

/* Vaults */
let vaults=JSON.parse(localStorage.getItem("vaults")||"{}");
let currentVault=localStorage.getItem("currentVault")||"default";
if(!vaults[currentVault]) vaults[currentVault]={notes:[],feeds:[]};
saveVaults();

function saveVaults(){
 localStorage.setItem("vaults",JSON.stringify(vaults));
 localStorage.setItem("currentVault",currentVault);
 renderVaults();
 rebuildEverything();
}
function createVault(){
 const n=document.getElementById("newVaultName").value.trim();
 if(!n) return;
 vaults[n]={notes:[],feeds:[]};
 currentVault=n;
 saveVaults();
}
function renderVaults(){
 const box=document.getElementById("vaultList");
 box.innerHTML="";
 Object.keys(vaults).forEach(v=>{
  const btn=document.createElement("button");
  btn.textContent=v+(v===currentVault?" ✓":"");
  btn.onclick=()=>{currentVault=v;saveVaults();};
  box.appendChild(btn);
 });
}

/* Helpers */
function allNotes(){return vaults[currentVault].notes;}
function allFeeds(){return vaults[currentVault].feeds;}
function tokenize(t){
 return t.toLowerCase()
  .replace(/[^a-z0-9\s]/g," ")
  .split(/\s+/)
  .filter(w=>w.length>2);
}

/* Keywords */
function keywordCounts(){
 let map=new Map();
 const add=w=>map.set(w,(map.get(w)||0)+1);
 allNotes().forEach(n=>tokenize(n.title+n.body).forEach(add));
 allFeeds().forEach(f=>tokenize(f.title).forEach(add));
 return [...map.entries()].sort((a,b)=>b[1]-a[1]);
}
function buildKeywordList(){
 let box=document.getElementById("keywordBox");
 box.innerHTML="";
 keywordCounts().slice(0,50).forEach(([k,c])=>{
  let s=document.createElement("span");
  s.className="keyword-pill";
  s.textContent=k+" ("+c+")";
  s.onclick=()=>filterByKeyword(k);
  box.appendChild(s);
 });
 drawKeywordChart();
}
function drawKeywordChart(){
 let pairs=keywordCounts().slice(0,10);
 let c=document.getElementById("keywordChart");
 let x=c.getContext("2d");
 x.clearRect(0,0,c.width,c.height);
 if(!pairs.length) return;
 let max=Math.max(...pairs.map(p=>p[1]));
 pairs.forEach((p,i)=>{
  let h=(p[1]/max)*160;
  x.fillStyle="#38bdf8";
  x.fillRect(20+i*30,200-h,20,h);
  x.fillStyle="white";
  x.fillText(p[0].slice(0,5),20+i*30,215);
 });
}
function filterByKeyword(k){
 let box=document.getElementById("keywordResults");
 box.innerHTML="<h3>"+k+"</h3>";
 allNotes().forEach(n=>{
  if((n.title+n.body).toLowerCase().includes(k)){
   let d=document.createElement("div");
   d.textContent="NOTE • "+n.title;
   box.appendChild(d);
  }
 });
}

/* Matrix */
function coMatrix(){
 let kws=keywordCounts().slice(0,16).map(p=>p[0]);
 let mat={};
 kws.forEach(a=>{mat[a]={};kws.forEach(b=>mat[a][b]=0);});
 function addPairs(words){
  for(let i=0;i<words.length;i++){
   for(let j=i+1;j<words.length;j++){
    let a=words[i],b=words[j];
    if(mat[a]&&mat[b]){mat[a][b]++;mat[b][a]++;}
   }
  }
 }
 allNotes().forEach(n=>addPairs(tokenize(n.title+n.body)));
 allFeeds().forEach(f=>addPairs(tokenize(f.title)));
 return mat;
}
function renderMatrix(){
 let m=coMatrix();
 let kws=Object.keys(m);
 let html="<table><tr><th></th>";
 kws.forEach(k=>html+="<th>"+k+"</th>");
 html+="</tr>";
 kws.forEach(a=>{
  html+="<tr><th>"+a+"</th>";
  kws.forEach(b=>html
</div></div>
